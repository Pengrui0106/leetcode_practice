#1211. Queries Quality and Percentage

#NOTE 1: CASE WHEN combined with SUM can give us a way to count something special.

SELECT query_name,
    ROUND(AVG(rating / `position`),2) AS quality,
    ROUND(
        SUM(CASE WHEN rating < 3 THEN 1 ELSE 0 END) / COUNT(*) * 100.0, 
        2) AS poor_query_percentage
FROM Queries
GROUP BY query_name
;

#1193. Monthly Transactions I

#NOTE 1: SUM(state = '') returns all the 1+1+1, while COUNT(state = '') returns all non-NULL rows.
#NOTE 2: DATE_FORMAT is a useful function when dealing with [date] data type.

SELECT 
    DATE_FORMAT(trans_date, '%Y-%m') AS month,
    country,
    COUNT(*) AS trans_count,
    SUM(state = 'approved') AS approved_count,
    SUM(amount) AS trans_total_amount,
    SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_total_amount
FROM Transactions
GROUP BY month, country
;


#1174. Immediate Food Delivery II

#NOTE 1: WHERE(,) means we filter the rows according to this tuple combinatioin condition.
#NOTE 2: CASE WHEN really useful. 


SELECT 
    ROUND(
        100.0 * SUM(
            CASE WHEN order_date = customer_pref_delivery_date
            THEN 1 ELSE 0 END
            ) / COUNT(*),
    2)
    AS immediate_percentage
FROM Delivery
WHERE (customer_id, order_date) IN
    (
        SELECT customer_id, MIN(order_date)
        FROM Delivery
        GROUP BY customer_id
    )
;
